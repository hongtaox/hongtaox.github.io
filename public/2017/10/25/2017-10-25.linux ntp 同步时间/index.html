<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>在linux ntp 时间同步 | ______</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">在linux ntp 时间同步</h1><a id="logo" href="/.">______</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">在linux ntp 时间同步</h1><div class="post-meta"><a href="/2017/10/25/2017-10-25.linux ntp 同步时间/#comments" class="comment-count"></a><p><span class="date">Oct 25, 2017</span><span><a href="/categories/linux/" class="category">linux</a></span></p></div><div class="post-content"><p>一、搭建时间同步服务器<br>1、编译安装ntp server<br>rpm -qa | grep ntp<br>若没有找到，则说明没有安装ntp包，从光盘上找到ntp包，使用<br>rpm -Uvh ntp<strong><em>.rpm<br>进行安装<br>2、修改ntp.conf配置文件<br>vi /etc/ntp.conf<br>①、第一种配置：允许任何IP的客户机都可以进行时间同步<br>将“restrict default nomodify notrap noquery”这行修改成：<br>restrict default nomodify notrap<br>配置文件示例：/etc/ntp.conf<br>②、第二种配置：只允许192.168.211.</em></strong>网段的客户机进行时间同步<br>在restrict default nomodify notrap noquery（表示默认拒绝所有IP的时间同步）之后增加一行：<br>restrict 192.168.211.0 mask 255.255.255.0 nomodify notrap<br>3、启动ntp服务<br>service ntpd start<br>开机启动服务<br>chkconfig ntpd on<br>4、ntpd启动后，客户机要等几分钟再与其进行时间同步，否则会提示“no server suitable for synchronization found”错误。</p>
<p>二、配置时间同步客户机<br>手工执行 ntpdate <ntp server=""> 来同步<br>或者利用crontab来执行<br>crontab -e<br>0 21 <em> </em> * ntpdate 192.168.211.22 &gt;&gt; /root/ntpdate.log 2&gt;&amp;1<br>每天晚上9点进行同步<br>附：<br>当用ntpdate -d 来查询时会发现导致 no server suitable for synchronization found 的错误的信息有以下2个：<br>错误1.Server dropped: Strata too high<br>在ntp客户端运行ntpdate serverIP，出现no server suitable for synchronization found的错误。<br>在ntp客户端用ntpdate –d serverIP查看，发现有“Server dropped: strata too high”的错误，并且显示“stratum 16”。而正常情况下stratum这个值得范围是“0~15”。<br>这是因为NTP server还没有和其自身或者它的server同步上。<br>以下的定义是让NTP Server和其自身保持同步，如果在/ntp.conf中定义的server都不可用时，将使用local时间作为ntp服务提供给ntp客户端。<br>server 127.127.1.0<br>fudge 127.127.1.0 stratum 8</ntp></p>
<p>在ntp server上重新启动ntp服务后，ntp server自身或者与其server的同步的需要一个时间段，这个过程可能是5分钟，在这个时间之内在客户端运行ntpdate命令时会产生no server suitable for synchronization found的错误。<br>那么如何知道何时ntp server完成了和自身同步的过程呢？<br>在ntp server上使用命令：</p>
<h1 id="watch-ntpq-p"><a href="#watch-ntpq-p" class="headerlink" title="watch ntpq -p"></a>watch ntpq -p</h1><p>出现画面：<br>Every 2.0s: ntpq -p                                                                                                             Thu Jul 10 02:28:32 2008</p>
<pre><code>remote           refid      st t when poll reach   delay   offset jitter
</code></pre><p>==============================================================================<br>192.168.30.22   LOCAL(0)         8 u   22   64    1    2.113 179133.   0.001<br>LOCAL(0)        LOCAL(0)        10 l   21   64    1    0.000   0.000  0.001<br>注意LOCAL的这个就是与自身同步的ntp server。<br>注意reach这个值，在启动ntp server服务后，这个值就从0开始不断增加，当增加到17的时候，从0到17是5次的变更，每一次是poll的值的秒数，是64秒*5=320秒的时间。<br>如果之后从ntp客户端同步ntp server还失败的话，用ntpdate –d来查询详细错误信息，再做判断。<br>错误2.Server dropped: no data<br>从客户端执行netdate –d时有错误信息如下：<br>transmit(192.168.30.22) transmit(192.168.30.22)<br>transmit(192.168.30.22)<br>transmit(192.168.30.22)<br>transmit(192.168.30.22)<br>192.168.30.22: Server dropped: no data<br>server 192.168.30.22, port 123<br>…..<br>28 Jul 17:42:24 ntpdate[14148]: no server suitable for synchronization found出现这个问题的原因可能有2：<br>1。检查ntp的版本，如果你使用的是ntp4.2（包括4.2）之后的版本，在restrict的定义中使用了notrust的话，会导致以上错误。<br>使用以下命令检查ntp的版本：</p>
<h1 id="ntpq-c-version"><a href="#ntpq-c-version" class="headerlink" title="ntpq -c version"></a>ntpq -c version</h1><p>下面是来自ntp官方网站的说明：<br>The behavior of notrust changed between versions 4.1 and 4.2.<br>In 4.1 (and earlier) notrust meant “Don’t trust this host/subnet for time”.<br>In 4.2 (and later) notrust means “Ignore all NTP packets that are not cryptographically authenticated.” This forces remote time servers to authenticate themselves to your (client) ntpd<br>解决：<br>把notrust去掉。<br>2。检查ntp server的防火墙。可能是server的防火墙屏蔽了upd 123端口。<br>可以用命令</p>
<p>#service iptables stop</p>
<p>来关掉iptables服务后再尝试从ntp客户端的同步，如果成功，证明是防火墙的问题，需要更改iptables的设置。</p>
</div><div class="tags"><a href="/tags/ntp/">ntp</a></div><div class="post-share"></div><div class="post-nav"><a href="/2017/10/25/2017-10-25.在linux下如何将文件夹打包/" class="pre">在linux下如何将文件夹打包</a><a href="/2017/10/25/2017-10-26.在linux下查找大文件/" class="next">linux下查找大文件</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#watch-ntpq-p"><span class="toc-text">watch ntpq -p</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ntpq-c-version"><span class="toc-text">ntpq -c version</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/2017-10-30.在linux添加定时任务/">linux添加定时任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/2017-10-26.在linux查看安装包/">linux下查找大文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/2017-10-25.在linux下如何将文件夹打包/">在linux下如何将文件夹打包</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/2017-10-25.linux ntp 同步时间/">在linux ntp 时间同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/2017-10-26.在linux下查找大文件/">linux下查找大文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/2017-09-27.不朽的失眠/">不朽的失眠</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/30/2016-12-30.Spark RPC通信层分析/">Spark RPC通信层分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/14/duoshuo-disqus-comment-count/">获取多说和 Disqus 文章评论数的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/13/hexo-collapsible-toc/">为 Hexo 添加可折叠的文章目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/hexo-local-search/">让 Hexo 博客支持本地站内搜索</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/散文/">散文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/术业专攻/">术业专攻</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自用笔记/">自用笔记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/自用笔记/术业专攻/">术业专攻</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/触类旁通/">触类旁通</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/PowerPoint/" style="font-size: 15px;">PowerPoint</a> <a href="/tags/HTML/" style="font-size: 15px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/EndNote/" style="font-size: 15px;">EndNote</a> <a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a> <a href="/tags/Reference/" style="font-size: 15px;">Reference</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Software/" style="font-size: 15px;">Software</a> <a href="/tags/多说/" style="font-size: 15px;">多说</a> <a href="/tags/UA/" style="font-size: 15px;">UA</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/TagCloud/" style="font-size: 15px;">TagCloud</a> <a href="/tags/Excel/" style="font-size: 15px;">Excel</a> <a href="/tags/Table/" style="font-size: 15px;">Table</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/PhotoShop/" style="font-size: 15px;">PhotoShop</a> <a href="/tags/GIF/" style="font-size: 15px;">GIF</a> <a href="/tags/PNG/" style="font-size: 15px;">PNG</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/Anki/" style="font-size: 15px;">Anki</a> <a href="/tags/Sublime/" style="font-size: 15px;">Sublime</a> <a href="/tags/font-family/" style="font-size: 15px;">font-family</a> <a href="/tags/Browsersync/" style="font-size: 15px;">Browsersync</a> <a href="/tags/DNS/" style="font-size: 15px;">DNS</a> <a href="/tags/Font-Awesome/" style="font-size: 15px;">Font-Awesome</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/Disqus/" style="font-size: 15px;">Disqus</a> <a href="/tags/JSON/" style="font-size: 15px;">JSON</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/rpc/" style="font-size: 15px;">rpc</a> <a href="/tags/散文/" style="font-size: 15px;">散文</a> <a href="/tags/Yelee/" style="font-size: 15px;">Yelee</a> <a href="/tags/ntp/" style="font-size: 15px;">ntp</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/zip/" style="font-size: 15px;">zip</a> <a href="/tags/tar/" style="font-size: 15px;">tar</a> <a href="/tags/crontable/" style="font-size: 15px;">crontable</a> <a href="/tags/WordPress/" style="font-size: 15px;">WordPress</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><!--a(href=config.root+"about/")= __("about")--></p><p><span> Copyright &copy;<a href="/." rel="nofollow">xcoder.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>